#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ÂÆâË£ÖÁÆÄÂçïÁöÑWebÁºñËæëÂô®
Âü∫‰∫éPythonÁöÑËΩªÈáèÁ∫ßÂú®Á∫øÁºñËæëÂô®
"""

import os
import http.server
import socketserver
import urllib.parse
import json
from pathlib import Path

class MarkdownEditorHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        # Â§ÑÁêÜnginx‰ª£ÁêÜË∑ØÂæÑ
        if self.path == '/' or self.path == '/editor' or self.path.startswith('/editor'):
            self.serve_editor()
        elif self.path.startswith('/api/files'):
            self.list_files()
        elif self.path.startswith('/api/read/'):
            self.read_file()
        else:
            super().do_GET()
    
    def do_POST(self):
        if self.path.startswith('/api/save/'):
            self.save_file()
        else:
            self.send_error(404)
    
    def serve_editor(self):
        """Êèê‰æõÁºñËæëÂô®ÁïåÈù¢"""
        html = '''
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìù Markdown ÁºñËæëÂô® - CUHK Study</title>
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body { 
            margin: 0; 
            font-family: 
                -apple-system, BlinkMacSystemFont, 
                'Segoe UI', 'Roboto', 'Helvetica Neue', 
                'PingFang SC', 'Hiragino Sans GB', 
                'Microsoft YaHei UI', 'Microsoft YaHei', 
                'Source Han Sans SC', 'Noto Sans CJK SC', 
                'WenQuanYi Micro Hei', sans-serif;
            background: #f9fafb;
            font-size: 14px;
            line-height: 1.6;
            color: #1a1b23;
        }
        .container { display: flex; height: 100vh; }
        .sidebar { 
            width: 300px; 
            background: #ffffff; 
            padding: 20px; 
            overflow-y: auto; 
            border-right: 1px solid #e1e4e8;
            box-shadow: 0 0 0 1px rgba(27, 31, 36, 0.08);
        }
        .editor { flex: 1; display: flex; flex-direction: column; }
        .toolbar { 
            background: linear-gradient(135deg, #7aa2f7 0%, #9d7cd8 100%); 
            color: white; 
            padding: 15px 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .content { flex: 1; display: flex; }
        .input { flex: 1; background: #fff; }
        .preview { 
            flex: 1; 
            background: white; 
            padding: 20px; 
            overflow-y: auto; 
            border-left: 1px solid #e9ecef;
            font-family: 
                -apple-system, BlinkMacSystemFont, 
                'Segoe UI', 'Roboto', 'Helvetica Neue',
                'PingFang SC', 'Hiragino Sans GB', 
                'Microsoft YaHei UI', 'Microsoft YaHei', 
                'Source Han Sans SC', 'Noto Sans CJK SC', 
                'WenQuanYi Micro Hei', sans-serif;
            font-size: 16px;
            line-height: 1.8;
            color: #000;
        }
        textarea { 
            width: 100%; 
            height: 100%; 
            border: none; 
            padding: 20px; 
            font-family: 
                'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono',
                'Source Code Pro', 'Menlo', 'Consolas', 
                'DejaVu Sans Mono', 'Ubuntu Mono', 'Courier New',
                'Microsoft YaHei UI', 'Microsoft YaHei', monospace;
            font-size: 16px; 
            line-height: 1.8;
            resize: none; 
            outline: none; 
            background: #fff;
            color: #000;
            font-feature-settings: "liga" 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* CodeMirror ÁºñËæëÂô®Ê†∑Âºè‰øÆÂ§ç */
        .CodeMirror {
            width: 100%;
            height: 100% !important;
            border: none;
            font-family: 
                'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono',
                'Source Code Pro', 'Menlo', 'Consolas', 
                'DejaVu Sans Mono', 'Ubuntu Mono', 'Courier New',
                'Microsoft YaHei UI', 'Microsoft YaHei', monospace;
            font-size: 16px;
            line-height: 1.8;
            background: #f7f7f7 !important;
        }
        
        .CodeMirror-scroll {
            height: 100% !important;
            overflow: auto !important;
            padding: 20px;
        }
        
        .CodeMirror-sizer {
            min-height: 100% !important;
        }
        /* Êñá‰ª∂Â§πÊ†∑Âºè */
        .folder-main {
            margin-bottom: 16px;
        }
        
        .folder-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #7aa2f7 0%, #9d7cd8 100%);
            color: white;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .folder-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(122, 162, 247, 0.3);
        }
        
        .folder-icon {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .folder-title {
            flex: 1;
        }
        
        .folder-toggle {
            transition: transform 0.2s ease;
            margin-left: 8px;
        }
        
        .folder-content {
            padding-left: 16px;
        }
        
        .folder-sub {
            margin-bottom: 8px;
        }
        
        .subfolder-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .subfolder-header:hover {
            background: #e1e4e8;
        }
        
        .subfolder-icon {
            margin-right: 6px;
        }
        
        .subfolder-title {
            flex: 1;
        }
        
        .file-count {
            color: #6c757d;
            font-size: 12px;
            margin-left: 4px;
        }
        
        .subfolder-toggle {
            transition: transform 0.2s ease;
            margin-left: 8px;
            font-size: 12px;
        }
        
        .subfolder-content {
            padding-left: 16px;
            margin-top: 4px;
        }
        
        .file-item { 
            padding: 8px 12px; 
            cursor: pointer; 
            border-radius: 6px; 
            margin: 2px 0; 
            transition: all 0.2s ease;
            border: 1px solid transparent;
            font-size: 14px;
            background: #fff;
            color: #000;
            position: relative;
            overflow: hidden;
        }
        .file-item:hover { 
            background: #f8f9fa;
            border-color: #e9ecef;
        }
        .file-item.active { 
            background: #7aa2f7;
            color: white; 
            box-shadow: 0 2px 8px rgba(122, 162, 247, 0.3);
            font-weight: 500;
        }
        

        
        /* Êñá‰ª∂Á±ªÂûãÂõæÊ†á */
        .file-item::before {
            content: "";
            font-size: 16px;
            margin-right: 8px;
            font-weight: bold;
        }
        .file-item.readme::before { content: "üìñ "; }
        .file-item.basic-page::before { content: "üè† "; }
        .file-item.main-content::before { content: "üìù "; }
        .file-item.ugfn::before { content: "üî¨ "; }
        .file-item.ugfh::before { content: "üé® "; }
        .file-item.misc::before { content: "üóÇÔ∏è "; }
        .file-item.docs::before { content: "üìã "; }
        .file-item.uploads::before { content: "üìÅ "; }
        .file-item.backup::before { content: "üóÑÔ∏è "; }
        button { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3); 
            padding: 8px 16px; 
            margin: 0 4px; 
            cursor: pointer; 
            border-radius: 6px; 
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button:hover { 
            background: rgba(255,255,255,0.3); 
            transform: translateY(-1px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .sidebar h3 {
            color: #495057;
            margin-top: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .current-file {
            font-weight: 500;
            font-size: 16px;
        }
        .toolbar-right {
            display: flex;
            gap: 8px;
        }
        /* ‰∏≠ÊñáÂ≠ó‰ΩìÂíåÊéíÁâà‰ºòÂåñ */
        .preview h1, .preview h2, .preview h3, .preview h4, .preview h5, .preview h6 {
            font-family: 
                -apple-system, BlinkMacSystemFont, 
                'Segoe UI', 'Roboto', 'Helvetica Neue',
                'PingFang SC', 'Hiragino Sans GB', 
                'Microsoft YaHei UI', 'Microsoft YaHei', 
                'Source Han Sans SC', 'Noto Sans CJK SC', sans-serif;
            color: #000;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            line-height: 1.4;
        }
        .preview p, .preview li {
            line-height: 1.8;
            color: #000;
            margin: 0.8em 0;
            word-break: break-word;
            word-wrap: break-word;
            font-size: 16px;
        }
        .preview code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 
                'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono',
                'Source Code Pro', 'Menlo', 'Consolas', 
                'Microsoft YaHei UI', monospace;
            font-size: 0.9em;
            color: #d73a49;
        }
        .preview pre {
            background: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #e1e4e8;
            line-height: 1.6;
        }
        .preview pre code {
            background: none;
            padding: 0;
            color: #24292e;
        }
        
        /* Hugo Front Matter Ê†∑Âºè - Ê∏©ÂíåÁâàÊú¨ */
        .preview .hugo-front-matter {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            padding: 12px 16px;
            margin: 16px 0;
            color: #495057;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            position: relative;
        }
        
        .preview .hugo-front-matter::before {
            content: "‚öôÔ∏è HugoÈÖçÁΩÆ";
            position: absolute;
            top: -8px;
            left: 12px;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #667eea;
            border: 1px solid #e9ecef;
        }
        
        .preview .hugo-front-matter .fm-field {
            display: flex;
            margin: 4px 0;
            align-items: flex-start;
        }
        
        .preview .hugo-front-matter .fm-key {
            color: #495057;
            font-weight: 600;
            min-width: 80px;
            margin-right: 8px;
        }
        
        .preview .hugo-front-matter .fm-value {
            color: #6c757d;
            flex: 1;
        }
        
        .preview .hugo-front-matter .fm-array {
            color: #28a745;
        }
        
        .preview .hugo-front-matter .fm-string {
            color: #6f42c1;
        }
        
        .preview .hugo-front-matter .fm-boolean {
            color: #e83e8c;
        }
        
        .preview .hugo-front-matter .fm-date {
            color: #17a2b8;
        }
        .preview blockquote {
            border-left: 4px solid #dfe2e5;
            padding-left: 16px;
            margin: 16px 0;
            color: #333;
            font-style: italic;
            font-size: 16px;
        }
        .preview table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }
        .preview th, .preview td {
            border: 1px solid #dfe2e5;
            padding: 8px 12px;
            text-align: left;
        }
        .preview th {
            background: #f6f8fa;
            font-weight: 600;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- CodeMirror for markdown syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/base16-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h3>üìÅ Markdown Êñá‰ª∂</h3>
            <div id="fileList"></div>
        </div>
        <div class="editor">
            <div class="toolbar">
                <span class="current-file" id="currentFile">ÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂ÂºÄÂßãÁºñËæë</span>
                <div class="toolbar-right">
                    <button onclick="saveFile()" id="saveBtn" disabled>üíæ ‰øùÂ≠ò</button>
                    <button onclick="refreshFiles()">üîÑ Âà∑Êñ∞</button>
                </div>
            </div>
            <div class="content">
                <div class="input">
                    <textarea id="editor" placeholder="ÈÄâÊã©‰∏Ä‰∏™ Markdown Êñá‰ª∂ÂºÄÂßãÁºñËæë...

ÊîØÊåÅ‰∏≠ÊñáÂ≠óÁ¨¶ËæìÂÖ•ÔºåÂåÖÊã¨Ôºö
- ÁÆÄ‰Ωì‰∏≠Êñá
- ÁπÅ‰Ωì‰∏≠Êñá  
- ‰∏≠ÊñáÊ†áÁÇπÁ¨¶Âè∑
- Ê∑∑Âêà‰∏≠Ëã±ÊñáÂÜÖÂÆπ

Âø´Êç∑ÈîÆÔºö
Ctrl+S: ‰øùÂ≠òÊñá‰ª∂" disabled></textarea>
                </div>
                <div class="preview" id="preview">
                    <h3>üìñ È¢ÑËßàÁ™óÂè£</h3>
                    <p>Markdown È¢ÑËßàÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫...</p>
                    <p>ÊîØÊåÅÂÆåÊï¥ÁöÑ‰∏≠ÊñáÂ≠óÁ¨¶Ê∏≤ÊüìÔºåÂåÖÊã¨‰∏≠Ëã±ÊñáÊ∑∑ÊéíÂíå‰∏≠ÊñáÊ†áÁÇπ„ÄÇ</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const currentFileSpan = document.getElementById('currentFile');
        const saveBtn = document.getElementById('saveBtn');
        let codeMirrorEditor = null;
        
        // ÂàùÂßãÂåñ CodeMirror
        window.addEventListener('load', function() {
            codeMirrorEditor = CodeMirror.fromTextArea(editor, {
                mode: 'markdown',
                lineNumbers: false,
                lineWrapping: true,
                theme: 'base16-light',
                styleActiveLine: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                styleSelectedText: true,
                fontSize: 16,
                extraKeys: {
                    "Ctrl-S": function() { saveFile(); },
                    "Ctrl-R": function() { refreshFiles(); }
                }
            });
            
            codeMirrorEditor.on('change', function() {
                updatePreview();
            });
            
            // ËÆæÁΩÆÁºñËæëÂô®Â≠ó‰ΩìÂ§ßÂ∞è
            codeMirrorEditor.getWrapperElement().style.fontSize = '16px';
            codeMirrorEditor.refresh();
        });
        
        // Êñá‰ª∂ÂàÜÁ±ªÂáΩÊï∞
        function getFileCategory(filePath) {
            const file = filePath.toLowerCase();
            
            // READMEÊñá‰ª∂
            if (file.includes('readme')) {
                return 'readme';
            }
            
            // Âü∫Á°ÄÈ°µÈù¢
            if (file.includes('content/authors/') || 
                file.includes('content/info.md') || 
                file.includes('content/_index.md') || 
                file.includes('info.md') || 
                file.includes('archetypes/')) {
                return 'basic-page';
            }
            
            // ‰∏ªË¶ÅÂÜÖÂÆπ
            if (file.includes('content/main/')) {
                return 'main-content';
            }
            
            // UGFNËØæÁ®ã
            if (file.includes('content/ugfn/') || file.includes('ugfn')) {
                return 'ugfn';
            }
            
            // UGFHËØæÁ®ã
            if (file.includes('content/ugfh/') || file.includes('ugfh')) {
                return 'ugfh';
            }
            
            // ÊùÇÈ°πÂÜÖÂÆπ
            if (file.includes('content/mess/') || file.includes('mess')) {
                return 'misc';
            }
            
            // ÊñáÊ°£ËµÑÊñô
            if (file.includes('docs/') || 
                file.includes('deployment') || 
                file.includes('test-')) {
                return 'docs';
            }
            
            // ‰∏ä‰º†Êñá‰ª∂
            if (file.includes('uploads/')) {
                return 'uploads';
            }
            
            // Â§á‰ªΩÊñá‰ª∂
            if (file.includes('.backup/') || 
                file.includes('backup') || 
                file.includes('resource')) {
                return 'backup';
            }
            
            // ÈªòËÆ§‰∏∫ÊñáÊ°£Á±ªÂûã
            return 'docs';
        }
        
        // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ
        document.addEventListener('keydown', function(e) {
            // Ctrl+S ‰øùÂ≠òÊñá‰ª∂
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            // Ctrl+R Âà∑Êñ∞Êñá‰ª∂ÂàóË°®
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshFiles();
            }
        });
        
        function updatePreview() {
            const markdown = codeMirrorEditor ? codeMirrorEditor.getValue() : editor.value;
            try {
                // Â§ÑÁêÜ Hugo Front Matter
                const processedMarkdown = processHugoFrontMatter(markdown);
                
                // ÈÖçÁΩÆ marked ‰ª•Êõ¥Â•ΩÂú∞ÊîØÊåÅ‰∏≠Êñá
                marked.setOptions({
                    breaks: true,  // ÊîØÊåÅ GitHub È£éÊ†ºÁöÑÊç¢Ë°å
                    gfm: true,     // ÂêØÁî® GitHub È£éÊ†ºÁöÑ Markdown
                });
                preview.innerHTML = marked.parse(processedMarkdown);
            } catch (error) {
                preview.innerHTML = '<p style="color: red;">È¢ÑËßàËß£ÊûêÈîôËØØ: ' + error.message + '</p>';
            }
        }
        
        // Â§ÑÁêÜ Hugo Front Matter
        function processHugoFrontMatter(content) {
            // Ê£ÄÊµã YAML Front Matter (---)
            const yamlMatch = content.match(/^---\\s*\\n([\\s\\S]*?)\\n---\\s*\\n([\\s\\S]*)$/);
            if (yamlMatch) {
                const frontMatter = yamlMatch[1];
                const markdownContent = yamlMatch[2];
                return renderFrontMatter(frontMatter, 'yaml') + '\\n\\n' + markdownContent;
            }
            
            // Ê£ÄÊµã TOML Front Matter (+++)
            const tomlMatch = content.match(/^\\+\\+\\+\\s*\\n([\\s\\S]*?)\\n\\+\\+\\+\\s*\\n([\\s\\S]*)$/);
            if (tomlMatch) {
                const frontMatter = tomlMatch[1];
                const markdownContent = tomlMatch[2];
                return renderFrontMatter(frontMatter, 'toml') + '\\n\\n' + markdownContent;
            }
            
            // Ê£ÄÊµã JSON Front Matter
            const jsonMatch = content.match(/^{([\\s\\S]*?)}\\s*\\n([\\s\\S]*)$/);
            if (jsonMatch) {
                const frontMatter = '{' + jsonMatch[1] + '}';
                const markdownContent = jsonMatch[2];
                return renderFrontMatter(frontMatter, 'json') + '\\n\\n' + markdownContent;
            }
            
            return content;
        }
        
        // Ê∏≤Êüì Front Matter
        function renderFrontMatter(frontMatter, type) {
            let html = '<div class="hugo-front-matter">';
            
            try {
                if (type === 'yaml') {
                    html += parseYamlFrontMatter(frontMatter);
                } else if (type === 'toml') {
                    html += '<pre>' + escapeHtml(frontMatter) + '</pre>';
                } else if (type === 'json') {
                    const parsed = JSON.parse(frontMatter);
                    html += formatJsonFrontMatter(parsed);
                }
            } catch (error) {
                html += '<pre>' + escapeHtml(frontMatter) + '</pre>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Ëß£Êûê YAML Front Matter
        function parseYamlFrontMatter(yaml) {
            const lines = yaml.split('\\n');
            let html = '';
            
            for (let line of lines) {
                line = line.trim();
                if (!line || line.startsWith('#')) continue;
                
                if (line.includes(':')) {
                    const [key, ...valueParts] = line.split(':');
                    const value = valueParts.join(':').trim();
                    
                    html += '<div class="fm-field">';
                    html += '<span class="fm-key">' + escapeHtml(key.trim()) + ':</span>';
                    html += '<span class="fm-value ' + getValueClass(value) + '">' + escapeHtml(value) + '</span>';
                    html += '</div>';
                } else if (line.startsWith('-')) {
                    html += '<div class="fm-field">';
                    html += '<span class="fm-key"></span>';
                    html += '<span class="fm-value fm-array">' + escapeHtml(line) + '</span>';
                    html += '</div>';
                } else {
                    html += '<div class="fm-field">';
                    html += '<span class="fm-value">' + escapeHtml(line) + '</span>';
                    html += '</div>';
                }
            }
            
            return html;
        }
        
        // Ê†ºÂºèÂåñ JSON Front Matter
        function formatJsonFrontMatter(obj, indent = 0) {
            let html = '';
            const spaces = '&nbsp;'.repeat(indent * 2);
            
            for (const [key, value] of Object.entries(obj)) {
                html += '<div class="fm-field">';
                html += '<span class="fm-key">' + spaces + escapeHtml(key) + ':</span>';
                
                if (Array.isArray(value)) {
                    html += '<span class="fm-value fm-array">[' + value.map(v => '"' + escapeHtml(String(v)) + '"').join(', ') + ']</span>';
                } else if (typeof value === 'object') {
                    html += '<span class="fm-value">{...}</span>';
                } else {
                    html += '<span class="fm-value ' + getValueClass(String(value)) + '">' + escapeHtml(String(value)) + '</span>';
                }
                html += '</div>';
            }
            
            return html;
        }
        
        // Ëé∑ÂèñÂÄºÁöÑCSSÁ±ª
        function getValueClass(value) {
            if (!value) return '';
            
            const trimmed = value.trim().replace(/["']/g, '');
            
            if (trimmed === 'true' || trimmed === 'false') return 'fm-boolean';
            if (trimmed.match(/^\\d{4}-\\d{2}-\\d{2}/)) return 'fm-date';
            if (value.includes('"') || value.includes("'")) return 'fm-string';
            
            return '';
        }
        
        // HTMLËΩ¨‰πâ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadFiles() {
            try {
                const response = await fetch('/api/files');
                const categorizedFiles = await response.json();
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                
                // Ê∏≤ÊüìÂàÜÁ±ªÊñá‰ª∂Â§πÁªìÊûÑ
                Object.entries(categorizedFiles).forEach(([mainCategory, subCategories]) => {
                    // ‰∏ªÂàÜÁ±ªÊ†áÈ¢ò
                    const mainCategoryDiv = document.createElement('div');
                    mainCategoryDiv.className = 'folder-main';
                    mainCategoryDiv.innerHTML = `
                        <div class="folder-header" onclick="toggleFolder(this)">
                            <span class="folder-icon">üìÇ</span>
                            <span class="folder-title">${mainCategory}</span>
                            <span class="folder-toggle">‚ñº</span>
                        </div>
                        <div class="folder-content">
                        </div>
                    `;
                    
                    const folderContent = mainCategoryDiv.querySelector('.folder-content');
                    
                    // Â≠êÂàÜÁ±ª
                    Object.entries(subCategories).forEach(([subCategory, files]) => {
                        if (files.length > 0) {
                            const subCategoryDiv = document.createElement('div');
                            subCategoryDiv.className = 'folder-sub';
                            subCategoryDiv.innerHTML = `
                                <div class="subfolder-header" onclick="toggleSubfolder(this)">
                                    <span class="subfolder-icon">üìÅ</span>
                                    <span class="subfolder-title">${subCategory}</span>
                                    <span class="file-count">(${files.length})</span>
                                    <span class="subfolder-toggle">‚ñº</span>
                                </div>
                                <div class="subfolder-content">
                                </div>
                            `;
                            
                            const subfolderContent = subCategoryDiv.querySelector('.subfolder-content');
                            
                            // Êñá‰ª∂ÂàóË°®
                            files.forEach(filename => {
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item';
                                fileItem.textContent = filename;
                                fileItem.onclick = () => loadFile(filename);
                                subfolderContent.appendChild(fileItem);
                            });
                            
                            folderContent.appendChild(subCategoryDiv);
                        }
                    });
                    
                    fileList.appendChild(mainCategoryDiv);
                });
            } catch (error) {
                console.error('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Êó∂Âá∫Èîô:', error);
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '<p style="color: red; padding: 8px;">‚ùå Êó†Ê≥ïÂä†ËΩΩÊñá‰ª∂ÂàóË°®</p>';
            }
        }
        
        async function loadFile(filename) {
            try {
                const response = await fetch(`/api/read/${encodeURIComponent(filename)}`);
                const content = await response.text();
                
                if (codeMirrorEditor) {
                    codeMirrorEditor.setValue(content);
                } else {
                    editor.value = content;
                    editor.disabled = false;
                }
                currentFile = filename;
                currentFileSpan.textContent = filename;
                saveBtn.disabled = false;
                
                // Update active file
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.toggle('active', item.textContent === filename);
                });
                
                updatePreview();
            } catch (error) {
                alert('‚ùå Âä†ËΩΩÊñá‰ª∂Êó∂Âá∫ÈîôÔºö' + error.message);
            }
        }
        
        async function saveFile() {
            if (!currentFile) return;
            
            try {
                const content = codeMirrorEditor ? codeMirrorEditor.getValue() : editor.value;
                const response = await fetch(`/api/save/${encodeURIComponent(currentFile)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: content
                });
                
                if (response.ok) {
                    alert('‚úÖ Êñá‰ª∂‰øùÂ≠òÊàêÂäüÔºÅ');
                } else {
                    throw new Error('‰øùÂ≠òÂ§±Ë¥•');
                }
            } catch (error) {
                alert('‚ùå ‰øùÂ≠òÊñá‰ª∂Êó∂Âá∫ÈîôÔºö' + error.message);
            }
        }
        
        function refreshFiles() {
            loadFiles();
        }
        
        // Êñá‰ª∂Â§πÊäòÂè†Â±ïÂºÄÂäüËÉΩ
        function toggleFolder(header) {
            const folderMain = header.closest('.folder-main');
            const content = folderMain.querySelector('.folder-content');
            const toggle = header.querySelector('.folder-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }
        
        function toggleSubfolder(header) {
            const folderSub = header.closest('.folder-sub');
            const content = folderSub.querySelector('.subfolder-content');
            const toggle = header.querySelector('.subfolder-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }
        
        // Load files on startup
        loadFiles();
    </script>
</body>
</html>
        '''
        
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.send_header('Cache-Control', 'no-cache')
        self.end_headers()
        self.wfile.write(html.encode('utf-8'))
    
    def list_files(self):
        """ÂàóÂá∫markdownÊñá‰ª∂Âπ∂ÊåâÊñá‰ª∂Â§πÂàÜÁ±ª"""
        md_files = []
        base_dir = Path('/root/cuhkstudy')
        
        for pattern in ['**/*.md', '**/*.markdown']:
            for file_path in base_dir.glob(pattern):
                rel_path = file_path.relative_to(base_dir)
                md_files.append(str(rel_path))
        
        # ÂàõÂª∫ÂàÜÁ±ªÁªìÊûÑ
        categorized = {
            "üìö ËØæÁ®ãÂÜÖÂÆπ": {
                "üî¨ UGFNËØæÁ®ã": [],
                "üé® UGFHËØæÁ®ã": [],
                "üóÇÔ∏è ÊùÇÈ°πÂÜÖÂÆπ": []
            },
            "üìÇ Âü∫Á°ÄÊñá‰ª∂": {
                "üìñ README": [],
                "üè† Âü∫Á°ÄÈ°µÈù¢": []
            },
            "üè∑Ô∏è Ê†áÁ≠æÂàÜÁ±ª": {
                "üéØ ‰∏ªË¶ÅÂÜÖÂÆπ (Main)": [],
                "üìö UGFNÊ†áÁ≠æ": [],
                "üé® UGFHÊ†áÁ≠æ": []
            }
        }
        
        # ÂàÜÁ±ªÊñá‰ª∂
        for file_path in md_files:
            file_lower = file_path.lower()
            
            # 1. README Êñá‰ª∂
            if 'readme' in file_lower:
                categorized["üìÇ Âü∫Á°ÄÊñá‰ª∂"]["üìñ README"].append(file_path)
                continue
                
            # 2. Âü∫Á°ÄÈ°µÈù¢ (authors, infoÁ≠â)
            if any(keyword in file_lower for keyword in ['author', 'info', '_index', 'about']):
                categorized["üìÇ Âü∫Á°ÄÊñá‰ª∂"]["üè† Âü∫Á°ÄÈ°µÈù¢"].append(file_path)
                continue
            
            # 3. ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπÊ£ÄÊü•Ê†áÁ≠æ
            try:
                full_path = base_dir / file_path
                with open(full_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    
                # Ê£ÄÊü• Front Matter ‰∏≠ÁöÑÊ†áÁ≠æ
                if 'tags:' in content or 'categories:' in content:
                    # ‰∏ªË¶ÅÂÜÖÂÆπÊ†áÁ≠æ
                    if '"Main"' in content or "'Main'" in content or '- Main' in content:
                        categorized["üè∑Ô∏è Ê†áÁ≠æÂàÜÁ±ª"]["üéØ ‰∏ªË¶ÅÂÜÖÂÆπ (Main)"].append(file_path)
                        continue
                    # UGFNÊ†áÁ≠æ
                    elif any(tag in content for tag in ['"UGFN"', "'UGFN'", '- UGFN', 'ugfn']):
                        categorized["üè∑Ô∏è Ê†áÁ≠æÂàÜÁ±ª"]["üìö UGFNÊ†áÁ≠æ"].append(file_path)
                        continue
                    # UGFHÊ†áÁ≠æ  
                    elif any(tag in content for tag in ['"UGFH"', "'UGFH'", '- UGFH', 'ugfh']):
                        categorized["üè∑Ô∏è Ê†áÁ≠æÂàÜÁ±ª"]["üé® UGFHÊ†áÁ≠æ"].append(file_path)
                        continue
            except:
                pass
            
            # 4. ÊåâË∑ØÂæÑÂàÜÁ±ªËØæÁ®ãÂÜÖÂÆπ
            if 'ugfn' in file_lower:
                categorized["üìö ËØæÁ®ãÂÜÖÂÆπ"]["üî¨ UGFNËØæÁ®ã"].append(file_path)
            elif 'ugfh' in file_lower:
                categorized["üìö ËØæÁ®ãÂÜÖÂÆπ"]["üé® UGFHËØæÁ®ã"].append(file_path)
            else:
                categorized["üìö ËØæÁ®ãÂÜÖÂÆπ"]["üóÇÔ∏è ÊùÇÈ°πÂÜÖÂÆπ"].append(file_path)
        
        self.send_response(200)
        self.send_header('Content-type', 'application/json; charset=utf-8')
        self.end_headers()
        self.wfile.write(json.dumps(categorized, ensure_ascii=False).encode('utf-8'))
    
    def read_file(self):
        """ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ"""
        file_path = urllib.parse.unquote(self.path[10:])  # Remove '/api/read/'
        full_path = Path('/root/cuhkstudy') / file_path
        
        try:
            with open(full_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            self.send_response(200)
            self.send_header('Content-type', 'text/plain; charset=utf-8')
            self.end_headers()
            self.wfile.write(content.encode('utf-8'))
        except Exception as e:
            self.send_error(500, str(e))
    
    def save_file(self):
        """‰øùÂ≠òÊñá‰ª∂"""
        file_path = urllib.parse.unquote(self.path[10:])  # Remove '/api/save/'
        full_path = Path('/root/cuhkstudy') / file_path
        
        try:
            content_length = int(self.headers['Content-Length'])
            content = self.rfile.read(content_length).decode('utf-8')
            
            # Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®
            full_path.parent.mkdir(parents=True, exist_ok=True)
            
            with open(full_path, 'w', encoding='utf-8') as f:
                f.write(content)
            
            self.send_response(200)
            self.send_header('Content-type', 'text/plain; charset=utf-8')
            self.end_headers()
            self.wfile.write('‰øùÂ≠òÊàêÂäü'.encode('utf-8'))
        except Exception as e:
            self.send_error(500, str(e))

def start_editor(port=8080):
    """ÂêØÂä®ÁºñËæëÂô®ÊúçÂä°"""
    os.chdir('/root/cuhkstudy')
    
    with socketserver.TCPServer(("", port), MarkdownEditorHandler) as httpd:
        print(f"üöÄ Markdown Editor started at http://localhost:{port}")
        print(f"üìù You can now edit markdown files in your browser!")
        print(f"üîó Open: http://your-server-ip:{port}")
        print(f"‚≠ê Press Ctrl+C to stop")
        httpd.serve_forever()

if __name__ == "__main__":
    import sys
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 8888
    start_editor(port)