# ğŸŒ CDNæ¶æ„è¯¦ç»†è¯´æ˜

## ğŸ“‹ æ¶æ„æ¦‚è§ˆ

æœ¬é¡¹ç›®é‡‡ç”¨äº†**æ™ºèƒ½æ··åˆCDNæ¶æ„**ï¼Œå°† nginx æœ¬åœ°æœåŠ¡ä¸ Cloudflare R2 å…¨çƒ CDN æ— ç¼ç»“åˆï¼Œå®ç°äº†é«˜æ€§èƒ½ã€ä½æˆæœ¬çš„é™æ€èµ„æºåˆ†å‘æ–¹æ¡ˆã€‚

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„å›¾

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[nginx]
    B --> C{æœ¬åœ°æ–‡ä»¶å­˜åœ¨?}
    C -->|æ˜¯| D[nginxç›´æ¥è¿”å›]
    C -->|å¦| E[ä»£ç†åˆ° R2 CDN]
    E --> F[Cloudflare R2]
    F --> G[å…¨çƒCDNèŠ‚ç‚¹]
    G --> H[è¿”å›æ–‡ä»¶åˆ°ç”¨æˆ·]
    
    subgraph "æœ¬åœ° nginx"
        D
        I[HTML/CSS/JS<br/>å°æ–‡ä»¶å¿«é€Ÿå“åº”]
    end
    
    subgraph "Cloudflare R2 CDN"
        F
        J[PDF/å¤§å›¾ç‰‡<br/>>100KBæ–‡ä»¶]
        K[å­—ä½“æ–‡ä»¶<br/>woff2ç¼“å­˜]
    end
```

## ğŸ¯ æ–‡ä»¶åˆ†å±‚ç­–ç•¥

### ğŸ“Š åˆ†å±‚è§„åˆ™

| æ–‡ä»¶ç±»å‹ | å¤§å°é˜ˆå€¼ | å­˜å‚¨ä½ç½® | ç¼“å­˜ç­–ç•¥ | è¯´æ˜ |
|---------|---------|---------|----------|------|
| **HTML/CSS/JS** | ä»»æ„å¤§å° | nginxæœ¬åœ° | 7å¤© | é¢‘ç¹æ›´æ–°ï¼Œæœ¬åœ°å“åº”å¿« |
| **PDFæ–‡æ¡£** | ä»»æ„å¤§å° | R2 CDN | 1å¹´ | å¤§æ–‡ä»¶ï¼Œå…¨çƒåˆ†å‘ |
| **å¤§å›¾ç‰‡** | >100KB | R2 CDN | 30å¤© | å‡å°‘å¸¦å®½æ¶ˆè€— |
| **å°å›¾æ ‡** | <100KB | nginxæœ¬åœ° | 30å¤© | å¿«é€ŸåŠ è½½ |
| **å­—ä½“æ–‡ä»¶** | ä»»æ„å¤§å° | R2 CDN | 30å¤© | è·¨é¡µé¢å¤ç”¨ |

### ğŸ”„ å»é‡ç­–ç•¥

é€šè¿‡ MD5 æ ¡éªŒå»é™¤é‡å¤æ–‡ä»¶ï¼š

```python
# ç›¸åŒMD5çš„æ–‡ä»¶åªä¿ç•™ä¸€ä»½ï¼Œä¼˜å…ˆçº§ï¼š
static/ > assets/ > public/
```

**å»é‡æˆæœ**ï¼š
- åŸå§‹æ–‡ä»¶ï¼š269ä¸ª
- ä¼˜åŒ–åï¼š48ä¸ªæ ¸å¿ƒæ–‡ä»¶
- èŠ‚çœå­˜å‚¨ï¼š~80%

## âš¡ æ€§èƒ½ä¼˜åŒ–

### ğŸš€ åŠ è½½é€Ÿåº¦ä¼˜åŒ–

1. **æ™ºèƒ½è·¯ç”±**
   ```nginx
   location ~* \.(pdf|jpg|png)$ {
       try_files $uri @r2_fallback;
   }
   ```

2. **ç¼“å­˜ç­–ç•¥**
   - æœ¬åœ°ç¼“å­˜ï¼š7-30å¤©
   - CDNç¼“å­˜ï¼š30å¤©-1å¹´
   - æµè§ˆå™¨ç¼“å­˜ï¼šimmutableæ ‡è®°

3. **å‹ç¼©ä¼ è¾“**
   - gzipå‹ç¼©ï¼šæ–‡æœ¬æ–‡ä»¶
   - å›¾ç‰‡ä¼˜åŒ–ï¼šWebPæ ¼å¼æ”¯æŒ

### ğŸ“ˆ å¸¦å®½èŠ‚çœ

- **CDNåˆ†å‘**ï¼š103.49MB å¤§æ–‡ä»¶èµ°å…¨çƒCDN
- **æœ¬åœ°æœåŠ¡**ï¼šå°æ–‡ä»¶nginxç›´æ¥è¿”å›
- **å‹ç¼©ä¼ è¾“**ï¼šå‡å°‘40-60%ä¼ è¾“é‡

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### nginx é…ç½®æ ¸å¿ƒ

```nginx
# è®¾ç½®R2ç«¯ç‚¹
set $r2_endpoint "https://447991a9c9d7dad31c67040315d483b2.r2.cloudflarestorage.com/cuhkstudy";

# PDFæ–‡ä»¶ä¼˜å…ˆR2
location ~* \.pdf$ {
    try_files $uri @r2_fallback;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# R2å›é€€å¤„ç†
location @r2_fallback {
    proxy_pass $r2_endpoint$uri;
    proxy_cache_valid 200 30d;
    add_header X-Served-From "r2-cdn";
}
```

### è‡ªåŠ¨åŒ–è„šæœ¬

1. **æ‰¹é‡ä¸Šä¼ **ï¼š`upload_to_r2.py`
   - å¹¶å‘ä¸Šä¼ ï¼ˆ10çº¿ç¨‹ï¼‰
   - è‡ªåŠ¨MIMEç±»å‹æ£€æµ‹
   - ä¸Šä¼ è¿›åº¦ç›‘æ§

2. **Hugoé›†æˆ**ï¼š`hugo_r2_sync.py`
   - æ„å»ºåè‡ªåŠ¨åŒæ­¥
   - åªåŒæ­¥é™æ€èµ„æº
   - å¢é‡æ›´æ–°

3. **æ¸…ç†ä¼˜åŒ–**ï¼š`r2_cleanup_optimize.py`
   - æ¸…ç†å†—ä½™æ–‡ä»¶
   - æ–‡ä»¶å»é‡
   - å­˜å‚¨æˆæœ¬ä¼˜åŒ–

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### çŠ¶æ€æ£€æŸ¥

```bash
# CDNçŠ¶æ€API
curl http://localhost/api/r2-status

# å“åº”ç¤ºä¾‹
{
  "status": "ok",
  "endpoint": "https://447991a9c9d7dad31c67040315d483b2.r2.cloudflarestorage.com/cuhkstudy",
  "timestamp": "2025-08-06T05:24:47Z"
}
```

### æ€§èƒ½æŒ‡æ ‡

- **TTFB (é¦–å­—èŠ‚æ—¶é—´)**ï¼š< 200ms (CDN)
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼š> 95%
- **å¸¦å®½èŠ‚çœ**ï¼š~70%

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹CDNå‘½ä¸­æƒ…å†µ
grep "X-Served-From" /var/log/nginx/cuhkstudy_access.log

# åˆ†æå“åº”æ—¶é—´
awk '$9 == 200 {print $11}' /var/log/nginx/cuhkstudy_access.log | sort -n
```

## ğŸ’° æˆæœ¬ä¼˜åŒ–

### Cloudflare R2 å®šä»·

- **å­˜å‚¨**ï¼š$0.015/GB/æœˆ
- **Class Aæ“ä½œ**ï¼š$4.50/ç™¾ä¸‡æ¬¡
- **Class Bæ“ä½œ**ï¼š$0.36/ç™¾ä¸‡æ¬¡
- **å‡ºç«™æµé‡**ï¼šå‰10GBå…è´¹

### æˆæœ¬ä¼°ç®—

å½“å‰é…ç½®ä¸‹æœˆåº¦æˆæœ¬ï¼š
- å­˜å‚¨ (103.49MB)ï¼š~$0.002
- æ“ä½œè´¹ç”¨ï¼š~$0.01
- **æ€»è®¡**ï¼š< $0.02/æœˆ

## ğŸ”§ éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒé…ç½®

```bash
# åˆ›å»ºç¯å¢ƒå˜é‡
cp .env.example .env
# å¡«å…¥R2å¯†é’¥ä¿¡æ¯
```

### 2. nginxé…ç½®

```bash
# åº”ç”¨CDNé…ç½®
cp nginx-r2-optimized.conf /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx
```

### 3. åˆå§‹åŒæ­¥

```bash
# æ‰¹é‡ä¸Šä¼ ç°æœ‰æ–‡ä»¶
python3 scripts/upload_to_r2.py

# æ¸…ç†ä¼˜åŒ–
python3 scripts/r2_cleanup_optimize.py
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **502 Bad Gateway**
   - æ£€æŸ¥R2ç«¯ç‚¹è¿é€šæ€§
   - éªŒè¯è®¿é—®å¯†é’¥æƒé™

2. **æ–‡ä»¶404**
   - ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ åˆ°R2
   - æ£€æŸ¥nginxé…ç½®è·¯å¾„

3. **ç¼“å­˜é—®é¢˜**
   - æ¸…ç†æµè§ˆå™¨ç¼“å­˜
   - é‡è½½nginxé…ç½®

### è°ƒè¯•å‘½ä»¤

```bash
# æµ‹è¯•R2è¿æ¥
aws s3 ls s3://cuhkstudy/ --profile r2-cuhkstudy --endpoint-url $R2_ENDPOINT

# æ‰‹åŠ¨æµ‹è¯•CDN
curl -H "Host: localhost" http://127.0.0.1/static/pdfs/test.pdf
```

## ğŸ”® æœªæ¥è§„åˆ’

### çŸ­æœŸä¼˜åŒ–

- [ ] WebPå›¾ç‰‡æ ¼å¼æ”¯æŒ
- [ ] HTTP/2æœåŠ¡å™¨æ¨é€
- [ ] æ›´ç»†ç²’åº¦ç¼“å­˜ç­–ç•¥

### é•¿æœŸè§„åˆ’

- [ ] å¤šCDNå‚å•†æ”¯æŒ
- [ ] æ™ºèƒ½å›¾ç‰‡å‹ç¼©
- [ ] è¾¹ç¼˜è®¡ç®—é›†æˆ

---

**ç»´æŠ¤**: å»ºè®®æ¯æœˆæ£€æŸ¥ä¸€æ¬¡CDNä½¿ç”¨æƒ…å†µå’Œæˆæœ¬ï¼ŒåŠæ—¶æ¸…ç†æ— ç”¨æ–‡ä»¶ã€‚